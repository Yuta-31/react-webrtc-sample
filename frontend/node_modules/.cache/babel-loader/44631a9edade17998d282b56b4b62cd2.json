{"ast":null,"code":"var _jsxFileName = \"/Users/yuta/Documents/work/web-rtc/frontend/src/VideoConnect5.js\",\n    _s = $RefreshSig$();\n\nimport React from 'react'; // import './Video.css';\n\nimport socketClient from 'socket.io-client';\nimport { Button, Stack, Grid, Card, CardMedia, CardActions } from '@mui/material';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst SERVER = \"http://localhst:3001\"; //\"https://webrtcreact.herokuapp.com\";\n\nconst socket = socketClient(SERVER);\nvar isHost = false;\nvar room = 'hoge';\nconst constraints = {\n  video: true,\n  audio: false\n};\nconst offerOptions = {\n  offerToReceiveVideo: 1\n};\nvar localStream = null;\nvar remoteStream = null;\nvar peerConnection = null;\nvar isStarted = false;\nlet config = {\n  \"iceServers\": [{\n    \"urls\": \"stun:stun.l.google.com:19302\"\n  }, {\n    \"urls\": \"stun:stun1.l.google.com:19302\"\n  }, {\n    \"urls\": \"stun:stun2.l.google.com:19302\"\n  }]\n};\nexport default function VideoConnect4() {\n  _s();\n\n  const localVideoRef = React.useRef(null);\n  const remoteVideoRef = React.useRef(null);\n  const [isKnocking, setIsKnocking] = React.useState(false);\n  const [canCalling, setCanCalling] = React.useState(false);\n  const [isAllowed, setIsAllowed] = React.useState(false);\n  socket.on('knocked response', (numClients, room) => {\n    if (numClients === 0) {\n      socket.emit('create', room);\n    } else if (numClients === 1) {\n      socket.emit('join', room);\n    } else {\n      console.log(\"room [\" + room + \"] is full.\");\n    }\n  });\n  socket.on('created', room => {\n    console.log('[Server said] you created room [' + room + ']');\n    isHost = true;\n\n    if (!isStarted) {\n      startConnect();\n    }\n  });\n  socket.on('joined', (room, id) => {\n    console.log('[Server said] ' + id + ' joined room [' + room + ']');\n\n    if (isHost) {\n      setIsKnocking(true);\n    } else {\n      if (!isStarted) {\n        startConnect();\n      }\n    }\n  });\n  socket.on('allowed', () => {\n    console.log('allowed!');\n    setIsAllowed(true);\n  });\n  socket.on('offer', description => {\n    console.log('Offer received');\n\n    if (!isHost && !isStarted) {\n      startConnect();\n    }\n\n    peerConnection.setRemoteDescription(description);\n    peerConnection.createAnswer().then(setLocalAndSendMessage).catch(handleAnswerError);\n  });\n  socket.on('answer', description => {\n    console.log('Answer received');\n\n    if (isStarted) {\n      peerConnection.setRemoteDescription(description);\n    }\n  });\n  socket.on('candidate', description => {\n    console.log('candidate Recieved');\n\n    if (isStarted) {\n      peerConnection.addIceCandidate(new RTCIceCandidate({\n        sdpMLineIndex: description.label,\n        candidate: description.candidate\n      }));\n    }\n  });\n\n  function createPeerConnection() {\n    try {\n      peerConnection = new RTCPeerConnection(config);\n      peerConnection.onicecandidate = handleConnection;\n      peerConnection.onaddstream = handleAddStream;\n      peerConnection.onremovestream = handleRemoveStream;\n      console.log('PeerConnection is created');\n    } catch (error) {\n      console.log('[ERROR]', error);\n      return;\n    }\n  }\n\n  function handleConnection(event) {\n    if (event.candidate && peerConnection.signalingState !== 'stable') {\n      console.log(peerConnection.signalingState);\n      socket.emit('message', {\n        type: 'candidate',\n        label: event.candidate.sdpMLineIndex,\n        id: event.candidate.sdpMid,\n        candidate: event.candidate.candidate\n      });\n    } else {\n      console.log('End of candidates');\n    }\n  }\n\n  function handleAddStream(event) {\n    console.log('add stream');\n    remoteStream = event.stream;\n  }\n\n  function handleRemoveStream(event) {\n    console.log(event);\n  }\n\n  function startConnect() {\n    createPeerConnection();\n    peerConnection.addStream(localStream);\n    isStarted = true;\n\n    if (!isHost) {\n      peerConnection.createOffer(offerOptions).then(setLocalAndSendMessage).catch(handleOfferError);\n    }\n  }\n\n  function setLocalAndSendMessage(description) {\n    peerConnection.setLocalDescription(description);\n    socket.emit('message', description);\n  }\n\n  function handleOfferError(error) {\n    console.log(\"[ERROR]\", error);\n  }\n\n  function handleAnswerError(error) {\n    console.log(\"[ERROR]\" + error.toString());\n  }\n\n  function allowJoin() {\n    console.log('allow');\n    socket.emit('allow');\n    setIsAllowed(true);\n  }\n\n  function calling() {\n    socket.emit('knock', room);\n  }\n\n  React.useEffect(() => {\n    navigator.mediaDevices.getUserMedia(constraints).then(stream => {\n      localStream = stream;\n      console.log(localStream);\n      localVideoRef.current.srcObject = stream;\n      setCanCalling(true);\n    }).catch(error => {\n      console.log(\"ERROR\", error);\n    });\n    const adapterScript = document.createElement('script');\n    adapterScript.src = \"https://webrtc.github.io/adapter/adapter-latest.js\";\n    adapterScript.async = true;\n    document.body.appendChild(adapterScript);\n    return () => {\n      document.body.removeChild(adapterScript);\n    };\n  }, []);\n  React.useEffect(() => {\n    remoteVideoRef.current.srcObject = remoteStream;\n  }, [isAllowed]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"VideoView\",\n    children: [/*#__PURE__*/_jsxDEV(Grid, {\n      container: true,\n      spacing: 2,\n      alignItems: \"center\",\n      justifyContent: \"center\",\n      children: [/*#__PURE__*/_jsxDEV(Grid, {\n        item: true,\n        xs: true,\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          children: /*#__PURE__*/_jsxDEV(Card, {\n            sx: {\n              width: 400,\n              height: 200\n            },\n            children: /*#__PURE__*/_jsxDEV(CardMedia, {\n              component: \"video\",\n              playsInline: true,\n              autoPlay: true,\n              ref: localVideoRef\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 191,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 190,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 189,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 188,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Grid, {\n        item: true,\n        xs: true,\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          children: /*#__PURE__*/_jsxDEV(Card, {\n            sx: {\n              width: 400,\n              height: 200\n            },\n            children: /*#__PURE__*/_jsxDEV(CardMedia, {\n              component: \"video\",\n              playsInline: true,\n              autoPlay: true,\n              ref: remoteVideoRef\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 198,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 197,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 196,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 195,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 187,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 203,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"center\", {\n      children: /*#__PURE__*/_jsxDEV(Card, {\n        sx: {\n          width: 400\n        },\n        children: /*#__PURE__*/_jsxDEV(CardActions, {\n          children: [/*#__PURE__*/_jsxDEV(Button, {\n            variant: \"contained\",\n            onClick: allowJoin,\n            disabled: !isKnocking,\n            children: \"ALLOW\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 207,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(Button, {\n            variant: \"contained\",\n            onClick: calling,\n            disabled: !canCalling,\n            children: \"CALL\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 208,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 206,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 205,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 204,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 186,\n    columnNumber: 5\n  }, this);\n}\n\n_s(VideoConnect4, \"OoemeHqe+FXX1mIaKeC1+mwwReg=\");\n\n_c = VideoConnect4;\n\nvar _c;\n\n$RefreshReg$(_c, \"VideoConnect4\");","map":{"version":3,"sources":["/Users/yuta/Documents/work/web-rtc/frontend/src/VideoConnect5.js"],"names":["React","socketClient","Button","Stack","Grid","Card","CardMedia","CardActions","SERVER","socket","isHost","room","constraints","video","audio","offerOptions","offerToReceiveVideo","localStream","remoteStream","peerConnection","isStarted","config","VideoConnect4","localVideoRef","useRef","remoteVideoRef","isKnocking","setIsKnocking","useState","canCalling","setCanCalling","isAllowed","setIsAllowed","on","numClients","emit","console","log","startConnect","id","description","setRemoteDescription","createAnswer","then","setLocalAndSendMessage","catch","handleAnswerError","addIceCandidate","RTCIceCandidate","sdpMLineIndex","label","candidate","createPeerConnection","RTCPeerConnection","onicecandidate","handleConnection","onaddstream","handleAddStream","onremovestream","handleRemoveStream","error","event","signalingState","type","sdpMid","stream","addStream","createOffer","handleOfferError","setLocalDescription","toString","allowJoin","calling","useEffect","navigator","mediaDevices","getUserMedia","current","srcObject","adapterScript","document","createElement","src","async","body","appendChild","removeChild","width","height"],"mappings":"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","sourcesContent":["import React from 'react';\n// import './Video.css';\nimport socketClient from 'socket.io-client';\nimport { Button, Stack, Grid, Card, CardMedia, CardActions } from '@mui/material';\n\nconst SERVER = \"http://localhst:3001\"//\"https://webrtcreact.herokuapp.com\";\n\nconst socket = socketClient(SERVER);\n\nvar isHost = false;\nvar room = 'hoge';\n\nconst constraints = {\n  video: true,\n  audio: false,\n}\nconst offerOptions = {\n  offerToReceiveVideo: 1,\n}\n\n\nvar localStream = null;\nvar remoteStream = null;\nvar peerConnection = null;\nvar isStarted = false;\n\nlet config = {\n  \"iceServers\": [\n    { \"urls\": \"stun:stun.l.google.com:19302\" },\n    { \"urls\": \"stun:stun1.l.google.com:19302\" },\n    { \"urls\": \"stun:stun2.l.google.com:19302\" },\n  ]\n};\n\n\nexport default function VideoConnect4() {\n  const localVideoRef = React.useRef(null);\n  const remoteVideoRef = React.useRef(null);\n  const [isKnocking, setIsKnocking] = React.useState(false);\n  const [canCalling, setCanCalling] = React.useState(false);\n  const [isAllowed, setIsAllowed] = React.useState(false);\n\n  socket.on('knocked response', (numClients, room) => {\n    if (numClients === 0) {\n      socket.emit('create', room);\n    } else if (numClients === 1) {\n      socket.emit('join', room);\n    } else {\n      console.log(\"room [\" + room + \"] is full.\");\n    }\n  });\n  socket.on('created', (room) => {\n    console.log('[Server said] you created room [' + room + ']');\n    isHost = true;\n    if (!isStarted) {\n      startConnect();\n    }\n  });\n  socket.on('joined', (room, id) => {\n    console.log('[Server said] ' + id + ' joined room [' + room + ']');\n    if (isHost) {\n      setIsKnocking(true);\n    } else {\n      if (!isStarted) {\n        startConnect();\n      }\n    }\n  });\n  socket.on('allowed', () => {\n    console.log('allowed!');\n    setIsAllowed(true);\n  });\n  socket.on('offer', (description) => {\n    console.log('Offer received');\n    if (!isHost && !isStarted) {\n      startConnect();\n    }\n    peerConnection.setRemoteDescription(description);\n    peerConnection.createAnswer()\n      .then(setLocalAndSendMessage)\n      .catch(handleAnswerError);\n  });\n  socket.on('answer', (description) => {\n    console.log('Answer received');\n    if (isStarted) {\n      peerConnection.setRemoteDescription(description);\n    }\n  });\n  socket.on('candidate', (description) => {\n    console.log('candidate Recieved');\n    if (isStarted) {\n      peerConnection.addIceCandidate(\n        new RTCIceCandidate({\n          sdpMLineIndex: description.label,\n          candidate: description.candidate,\n        })\n      );\n    }\n  });\n\n  function createPeerConnection() {\n    try {\n      peerConnection = new RTCPeerConnection( config );\n      peerConnection.onicecandidate = handleConnection;\n      peerConnection.onaddstream = handleAddStream;\n      peerConnection.onremovestream = handleRemoveStream;\n      console.log('PeerConnection is created');\n    } catch (error) {\n      console.log('[ERROR]', error);\n      return;\n    }\n  }\n  function handleConnection(event) {\n    if (event.candidate && peerConnection.signalingState !== 'stable') {\n      console.log(peerConnection.signalingState);\n      socket.emit('message', {\n        type: 'candidate',\n        label: event.candidate.sdpMLineIndex,\n        id: event.candidate.sdpMid,\n        candidate: event.candidate.candidate\n      });\n    } else {\n      console.log('End of candidates');\n    }\n  }\n  function handleAddStream(event) {\n    console.log('add stream');\n    remoteStream = event.stream;\n  }\n  function handleRemoveStream(event) {\n    console.log(event);\n  }\n  function startConnect() {\n    createPeerConnection();\n    peerConnection.addStream(localStream);\n    isStarted = true;\n    if (!isHost) {\n      peerConnection.createOffer(offerOptions)\n        .then(setLocalAndSendMessage)\n        .catch(handleOfferError);\n    }\n  }\n  function setLocalAndSendMessage(description) {\n    peerConnection.setLocalDescription(description);\n    socket.emit('message', description);\n  }\n  function handleOfferError(error) {\n    console.log(\"[ERROR]\", error);\n  }\n  function handleAnswerError(error) {\n    console.log(\"[ERROR]\" + error.toString());\n  }\n  function allowJoin() {\n    console.log('allow');\n    socket.emit('allow');\n    setIsAllowed(true);\n  }\n  function calling() {\n    socket.emit('knock', room);\n  }\n\n  React.useEffect(() => {\n    navigator.mediaDevices.getUserMedia(constraints)\n      .then((stream) => {\n        localStream = stream;\n        console.log(localStream);\n        localVideoRef.current.srcObject = stream;\n        setCanCalling(true);\n      })\n      .catch((error) => {\n        console.log(\"ERROR\", error);\n      });\n    const adapterScript = document.createElement('script');\n    adapterScript.src = \"https://webrtc.github.io/adapter/adapter-latest.js\";\n    adapterScript.async = true;\n    document.body.appendChild(adapterScript);\n    return () => {\n      document.body.removeChild(adapterScript);\n    };\n  }, []);\n  React.useEffect(() => {\n    remoteVideoRef.current.srcObject = remoteStream;\n  },[isAllowed]);\n\n  return (\n    <div className=\"VideoView\">\n      <Grid container spacing={2} alignItems=\"center\" justifyContent=\"center\">\n        <Grid item xs>\n          <div>\n            <Card sx={{ width: 400, height: 200 }}>\n              <CardMedia component=\"video\" playsInline autoPlay ref={localVideoRef} />\n            </Card>\n          </div>\n        </Grid>\n        <Grid item xs>\n          <div>\n            <Card sx={{ width: 400, height: 200 }}>\n              <CardMedia component=\"video\" playsInline autoPlay ref={remoteVideoRef} />\n            </Card>\n          </div>\n        </Grid>\n      </Grid>\n      <br />\n      <center>\n        <Card sx={{width: 400}}>\n          <CardActions>\n            <Button variant=\"contained\" onClick={allowJoin} disabled={!isKnocking}>ALLOW</Button>\n            <Button variant=\"contained\" onClick={calling} disabled={!canCalling}>CALL</Button>\n          </CardActions>\n        </Card>\n      </center>\n    </div>\n  )\n}\n"]},"metadata":{},"sourceType":"module"}